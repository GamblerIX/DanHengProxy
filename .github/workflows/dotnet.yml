# ============================================================================
# æ–‡ä»¶: .github/workflows/dotnet.yml
# æè¿°: è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ DanHengProxy çš„å·¥ä½œæµã€‚
#      æ”¯æŒæ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å·å‘å¸ƒæˆ–ä»…è¿›è¡Œæ„å»ºæµ‹è¯•ã€‚
# ç›¸å…³æ–‡ä»¶:
#   - DanHengProxy.csproj  : é¡¹ç›®é…ç½®æ–‡ä»¶
#   - config.tmpl.json     : é…ç½®æ¨¡æ¿
#   - Program.cs           : ç¨‹åºå…¥å£ç‚¹
#   - ProxyService.cs      : ä»£ç†æ ¸å¿ƒé€»è¾‘
#   - README.md            : é¡¹ç›®å¿«é€Ÿå…¥é—¨æŒ‡å—
# ============================================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚ 2.2.0)ã€‚å¦‚æœç•™ç©ºï¼Œåˆ™ä»…è¿›è¡Œæ„å»ºæµ‹è¯•ï¼Œä¸åˆ›å»º Releaseã€‚'
        required: false
        default: ''

# ----------------------------------------------------------------------------
# ç¯å¢ƒå˜é‡å®šä¹‰
# ----------------------------------------------------------------------------
env:
  PROJECT_PATH: 'DanHengProxy.csproj'
  DOTNET_VERSION: '8.0.x'
  OUTPUT_DIR: './publish'
  RUNTIME: 'win-x64'

jobs:
  build:
    name: Build Windows x64
    runs-on: windows-latest
    outputs:
      should_release: ${{ steps.check_release.outputs.should_release }}
      release_tag: ${{ steps.check_release.outputs.release_tag }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check Release Condition
      id: check_release
      shell: pwsh
      run: |
        $shouldRelease = "false"
        $tag = ""
        
        if ("${{ github.ref_type }}" -eq "tag") {
            $shouldRelease = "true"
            $tag = "${{ github.ref_name }}"
        } elseif ("${{ github.event.inputs.version }}" -ne "") {
            $shouldRelease = "true"
            $tag = "v${{ github.event.inputs.version }}"
            if ($tag -notmatch "^v") { $tag = "v$tag" }
        }
        
        Write-Host "Should Release: $shouldRelease"
        Write-Host "Release Tag: $tag"
        echo "should_release=$shouldRelease" >> $env:GITHUB_OUTPUT
        echo "release_tag=$tag" >> $env:GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Publish AOT
      run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -r ${{ env.RUNTIME }} --self-contained true -p:PublishAot=true -o ${{ env.OUTPUT_DIR }}

    - name: Prepare and Zip Artifacts
      id: zip
      shell: pwsh
      run: |
        # ç§»é™¤è°ƒè¯•ç¬¦å·æ–‡ä»¶
        Get-ChildItem -Path ${{ env.OUTPUT_DIR }} -Include *.pdb,*.dbg -Recurse | Remove-Item -Force
        
        if (!(Test-Path "${{ env.OUTPUT_DIR }}/config.tmpl.json")) {
            Copy-Item "./config.tmpl.json" "${{ env.OUTPUT_DIR }}/config.tmpl.json"
        }
        
        $tag = "${{ steps.check_release.outputs.release_tag }}"
        if ($tag -eq "") { $tag = "test-build" }
        $zipName = "DanHengProxy_${{ env.RUNTIME }}_$tag"
        
        Write-Host "Creating archive: $zipName.zip"
        Compress-Archive -Path ${{ env.OUTPUT_DIR }}/* -DestinationPath "$zipName.zip"
        echo "zip_path=$zipName.zip" >> $env:GITHUB_OUTPUT

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.RUNTIME }}-artifact
        path: "*.zip"

  release:
    name: Create GitHub Release
    needs: build
    if: needs.build.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.release_tag }}
          name: "DanHengProxy ${{ needs.build.outputs.release_tag }} Release"
          body: |
            ### ğŸ› ï¸ ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½ä¸‹æ–¹å¯¹åº”çš„ `.zip` å‹ç¼©åŒ…å¹¶è§£å‹ã€‚
            2. æ ¹æ®éœ€è¦å‚è€ƒ [å¿«é€Ÿå…¥é—¨æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/README.md) è¿›è¡Œé…ç½®ã€‚
            3. è¿è¡Œ `DanHengProxy.exe` å¯åŠ¨ä»£ç†æœåŠ¡ã€‚
          files: "artifacts/*.zip"
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
